---
name: ecs-broker-tile
icon_file: resources/icon.png
label: DELL EMC ECS Broker
description: ECS Broker for Pivotal CF
metadata_version: 1.8
rank: 50
stemcell_criteria:
  os: ubuntu-trusty
  version: '3363.15'
  requires_cpi: false
properties:
- name: encryption_key
  type: secret
- name: vm_credentials
  type: salted_credentials
  default:
    identity: vcap
- name: org_quota
  type: integer
  configurable: false
  constraints:
    min: 512
    max: 4096
  default: 4096
- name: memory
  type: integer
  configurable: false
  constraints:
    min: 256
    max: 4096
  default: 4096
- name: internal_service_names
  type: string
  configurable: false
  default: "ecs-bucket"
forms:
- name: ecs_broker_app
  label: Service Broker Application
  description: Service Broker CF App Configuration Details
  properties:
    - name: app_name
      type: string
      label: Service Broker Application Name
      description: Enter the name for the Service Broker App
      configurable: true
      default: ecs-broker
    - name: app_version
      label: Service Broker Application version
      description: Enter the version of the Service Broker App (Final app name would include app version like ${appName}-${appversion}
      type: string
      configurable: true
      default: v1
    - name: app_uri
      label: Service Broker Application URI
      description: Enter the URI/endpoint for the Service Broker app (on push to CF)
      type: string
      configurable: true
      default: ecs-broker
    - name: create_open_security_group
      label: Open up Security Groups
      description: Open up security group on CF for Service Broker to access other apps or CF Cloud Controller
      type: boolean
      configurable: true
    - name: enable_global_access_to_plans
      label: Enable Global access to all Services and Plans
      description: Open up access to all service plans across all orgs and spaces. If set to false, administrators must use the "enable-service-access" command to allow access
      type: boolean
      configurable: true
      default: true
- name: ecs_connection
  label: Dell EMC ECS Connectivity
  description: Service Broker ECS Connection Details
  properties:
    - name: management_endpoint
      label: ECS Management Endpoint
      description: Enter the URI/endpoint for the ECS HTTPS management API. This is typically accessed from port `4443`, but may be on a different port if accessed through a load balancer
      type: string
      configurable: true
    - name: replication_group
      label: Replication Group
      description: Enter the name of the ECS "replication group" to be used for created buckets. This can be found in the ECS management UI
      type: string
      configurable: true
    - name: namespace
      label: Namespace
      description: Enter the name of the ECS "namespace" to be used for created buckets and users. This can be found in the ECS management UI
      type: string
      configurable: true
    - name: api_username
      label: ECS Admin Username
      description: Enter the name of the ECS Management API admin user. This should be a namespace admin or system administrator management user on the ECS
      type: string
      configurable: true
    - name: api_password
      label: ECS Admin Password
      description: Enter the ECS Management API password
      type: string
      configurable: true
    - name: base_url
      label: ECS Base URL
      description: (Optional) Enter the name of the ECS configured base URL, to discover the object endpoint. If not provided, the broker will attempt to discover a default base URL. Alternatively, the URI/endpoint can be specified using the "Object Endpoint" parameter
      type: string
      configurable: true
      optional: true
    - name: certificate
      label: ECS Management Certification
      description: SSL certificate to enable broker to communicate with ECS API Managment. This is required for self-signed certificates, but may not be needed when the ECS is configured with a signed certificate from a trusted source
      type: text
      configurable: true
    - name: object_endpoint
      label: ECS Object Endpoint
      description: (Optional) Manually specify the URI/endpoint of the ECS S3 API, rather than discover from the ECS configured "base URL". This is typically accessed form port 9020 (HTTP) or port 9021 (HTTPS), but may be on a different port if accessed through a load balancer
      type: string
      configurable: true
      optional: true
- name: broker_service_details
  label: Service Broker Webservice Settings
  description: Service Broker Webservice Settings
  properties:
    - name: api_version
      label: ECS Management API Version
      description: The Cloud Foundry service broker API version that the broker should advertise. This should be configured to be compatible with the release of Cloud Foundry
      type: string
      configurable: true
      default: "*"
    - name: prefix
      label: Broker Prefix
      description: (Optional) Enter a string used to prefix all broker created buckets and users. Defaults to "ecs-cf-broker-"
      type: string
      configurable: true
      optional: true
    - name: repository_endpoint
      label: Repository Endpoint
      description: (Optional) Enter the URI/endpoint for the ECS S3 API that should be used for storing broker metadata.  Defaults to the object endpoint or base URL
      type: string
      configurable: true
      optional: true
    - name: repository_user
      label: Repository User
      description: (Optional) Enter the name of the user that should be created/used for managing broker metadata. Defaults to "{prefix}-user"
      type: string
      configurable: true
      optional: true
    - name: repository_bucket
      label: Repository Bucket
      description: (Optional) Enter the name of the bucket that should be created/used for managing broker metadata. Defaults to {prefix}-repository
      type: string
      configurable: true
      optional: true
    - name: security_username
      label: ECS Broker Security Username
      description: Enter the name to register broker. Defaults to "user"
      type: string
      configurable: true
      default: user
    - name: security_password
      label: ECS Broker Password
      description: Enter the password to register broker. Defaults to "password"
      type: string
      configurable: true
      default: password
- name: service-1
  label: Catalog Service 1
  description: Configure Catalog Service 1
  properties:
  - name: service-1-active
    default: true
    label: Enable Catalog Service 1
    description: If enabled, this service will be included in the broker catalog, which supplies the Cloud Foundry marketplace.
    configurable: true
    type: boolean
  - name: name
    label: Name
    type: string
    configurable: true
    description: Service named used in the Cloud Foundry marketplace. This should be kept fairly short
    default: ecs-namespace
  - name: repository_service
    type: boolean
    label: Enable as Repository Service
    description: Use this service for the internal metadata of the broker. This should only be enabled for one service, as the broker may pick from repository enabled services at random on startup.
    configurable: true
    default: false
  - name: description
    label: Description
    type: string
    configurable: true
    description: Full description of the service appearing in the marketplace
    default: Dell EMC ECS private object storage namespace
  - name: display_name
    default: ECS Namespace
    label: Display Name
    type: string
    configurable: true
    description: The name that will show in the PCF Apps Manager Marketplace
  - name: image_url
    label: Image URL
    type: http_url
    configurable: true
    default: https://avatars.githubusercontent.com/u/12926680
    description: The image that will show in the PCF Apps Manager Marketplace
  - name: long_description
    default: Dell EMC Elastic Cloud Storage (ECS) private object storage Namespace
    type: text
    label: Long Description
    configurable: true
    description: A long description to use for the service, which will show in the PCF Apps Manager Marketplace
  - name: provider_display_name
    label: Provider Display Name
    type: string
    default: Dell EMC
    configurable: true
    description: Provider name that will show in the PCF Apps Manager Marketplace
  - name: documentation_url
    label: Documentation URL
    type: http_url
    configurable: true
    default: https://community.emc.com/docs/DOC-45012
    description: The documentation link that will show in the PCF Apps Manager Marketplace
  - name: support_url
    label: Support URL
    type: http_url
    configurable: true
    default: http://www.emc.com/products-solutions/trial-software-download/ecs.htm
    description: The support link that will show in the PCF Apps Manager Marketplace
  - name: bindable
    label: Binable
    type: boolean
    default: true
    configurable: true
    description: Determines if this service can be bound to user applications. This should typically be enabled, but could be disabled for internal-only services
  - name: service_type
    type: selector
    label: Service Type
    configurable: true
    default: Namespace
    description: Set the type of service to be available in the marketplace. A bucket provides a single bucket per service. A namespace provides a tentant "area" where multiple buckets can be provisioned
    option_templates:
    - name: namespace_option
      select_value: Namespace
      property_blueprints:
      - name: compliance_enabled
        type: boolean
        label: Enable Compliance
        default: false
        configurable: true
        description: Strongly enforce object retention for compliance. This only applies to namespace services
      - name: default_bucket_quota
        type: integer
        label: Default Bucket Quota (GB)
        optional: true
        configurable: true
        description: Default quota applied to all buckets created within this namespacedefault_bucket_quota. This only applies to namespace services
    - name: bucket_option
      select_value: Bucket
      property_blueprints:
      - name: head_type
        label: Object Head Type
        type: dropdown_select
        default: s3
        configurable: false
        description: Object protocol to use for the provisioned bucket. Today the broker only supports S3, but will support Swift, Atmos & CAS in the future. This only applies to bucket services
        options:
        - name: s3
          label: S3
      - name: file_accessible
        label: Enable File Access
        type: boolean
        default: false
        configurable: true
        description: Enable NFS and HDFS access for provisioned buckets. This also enables volume mount services for the service, so a bucket can be used as an application mount point. File access cannot be changed after creation, so this setting cannot be changed by plan upgrades. This only applies to bucket services
      - name: default_retention
        type: integer
        label: Default Retention (Seconds)
        optional: true
        configurable: true
        description: The default object number of seconds an object should be retained. The object cannot be deleted until that time has elapsed. This can be set to -1 for infinite retention. This only applies to bucket services
  - name: quota_limit
    type: integer
    label: Quota Limit (GB)
    optional: true
    configurable: true
    description: The capacity quota limit in gigabytes. A user will not be able to store more than this amount in a provisioned bucket or namespace
  - name: quota_warn
    type: integer
    label: Quota Warning (GB)
    optional: true
    configurable: true
    description: The capacity quota warning in gigabytes. A ECS warning notification will be generated when a user consumes this amount of storage
  - name: encrypted
    label: Enable Encryption
    type: boolean
    default: false
    configurable: true
    description: Enabled encryption on this service. Encryption cannot be changed after creation, so this setting cannot be changed by plan upgrades
  - name: access_during_outage
    label: Enable Access During Outage
    type: boolean
    default: true
    configurable: true
    description: This allows a bucket or namespace to remain online even if the primary site is offline. This is typically enabled, but can be disabled if strict data consistency is required, since actual replication is asynchronous
  - name: plans
    type: collection
    label: Plans
    configurable: true
    property_blueprints:
    - name: name
      type: string
      label: Name
      configurable: true
      description: Name of this service plan to show in Cloud Foundry marketplace
    - name: description
      type: string
      label: Description
      configurable: true
      description: Description of this service plan to show in Cloud Foundry marketplace
    - name: cost_usd
      type: string
      label: Cost in US Dollars
      configurable: true
      description: The cost for the plan based on the "Cost Unit". Should be in the form of a float -- 0.00
    - name: bullets
      type: string_list
      label: Bullet Points
      configurable: true
      description: Bullet points to show up about the plan in the PCF Marketplace.
    - name: cost_unit
      type: string
      label: Cost Unit
      configurable: true
      description: The unit for each to charge. By convention is should be in ALL CAPS. Examples include MONTHLY, PER_GB, PER_GB_PER_MONTH
    - name: quota_limit
      type: integer
      label: Quota Limit (GB)
      optional: true
      configurable: true
      description: The capacity quota limit in gigabytes. A user will not be able to store more than this amount in a provisioned bucket or namespace
    - name: quota_warn
      type: integer
      label: Quota Warning (GB)
      optional: true
      configurable: true
      description: The capacity quota warning in gigabytes. A ECS warning notification will be generated when a user consumes this amount of storage
    - name: free
      type: boolean
      label: Free of Charge
      configurable: true
      description: Whether this service is free or paid
    - name: access_during_outage
      label: Enable Access During Outage
      type: boolean
      default: true
      configurable: true
      description: This allows a bucket or namespace to remain online even if the primary site is offline. This is typically enabled, but can be disabled if strict data consistency is required, since actual replication is asynchronous
    - name: default_retention
      type: integer
      label: Default Retention (Seconds)
      optional: true
      configurable: true
      description: The default object number of seconds an object should be retained. The object cannot be deleted until that time has elapsed. This can be set to -1 for infinite retention. This only applies to bucket services
    default:
    - name: 5gb
      description: 5 GB free trial
      cost_usd: 0.00
      cost_unit: MONTHLY
      quota_limit: 5
      quota_warn: 4
      free: true
      bullets:
      - Shared Object Storage
      - 5 GB Storage Limit
      - S3 Protocol Access
    - name: unlimited
      description: Usage based billing
      cost_usd: 0.03
      cost_unit: PER_GB_PER_MONTH
      bullets:
      - Shared Object Storage
      - Unlimited Storage
      - S3 Protocol Access
packages:
- name: ecs-broker
  type: bosh-release
  path: resources/ecs-broker-1.5.1.tgz
  jobs:
  - name: deploy-service-broker
    resource_label: Deploy Ecs Service Broker
    templates:
    - name: deploy-service-broker
      release: ecs_broker
    lifecycle: errand
    post_deploy: true
    run_post_deploy_errand_default: when-changed
    resource_definitions:
    - name: ram
      type: integer
      configurable: false
      default: 1024
    - name: ephemeral_disk
      type: integer
      configurable: false
      default: 1024
    - name: persistent_disk
      type: integer
      configurable: false
      default: 0
    - name: cpu
      type: integer
      configurable: false
      default: 1
    static_ip: 0
    dynamic_ip: 1
    max_in_flight: 1
    instance_definitions:
    - name: instances
      type: integer
      configurable: false
      default: 1
    properties:
      vm_credentials:
        type: salted_credentials
        default:
          identity: vcap
  - name: register-broker
    resource_label: Register Ecs Service Broker
    templates:
    - name: register-broker
      release: ecs_broker
    lifecycle: errand
    post_deploy: true
    run_post_deploy_errand_default: when-changed
    resource_definitions:
    - name: ram
      type: integer
      configurable: false
      default: 1024
    - name: ephemeral_disk
      type: integer
      configurable: false
      default: 1024
    - name: persistent_disk
      type: integer
      configurable: false
      default: 0
    - name: cpu
      type: integer
      configurable: false
      default: 1
    static_ip: 0
    dynamic_ip: 1
    max_in_flight: 1
    instance_definitions:
    - name: instances
      type: integer
      configurable: false
      default: 1
    properties:
      vm_credentials:
        type: salted_credentials
        default:
          identity: vcap
  - name: destroy-broker
    resource_label: Remove Ecs Service Broker
    templates:
    - name: destroy-broker
      release: ecs_broker
    lifecycle: errand
    pre_delete: true
    run_pre_delete_errand_default: when-changed
    resource_definitions:
    - name: ram
      type: integer
      configurable: false
      default: 1024
    - name: ephemeral_disk
      type: integer
      configurable: false
      default: 1024
    - name: persistent_disk
      type: integer
      configurable: false
      default: 0
    - name: cpu
      type: integer
      configurable: false
      default: 1
    static_ip: 0
    dynamic_ip: 1
    max_in_flight: 1
    instance_definitions:
    - name: instances
      type: integer
      configurable: false
      default: 1
    properties:
      vm_credentials:
        type: salted_credentials
        default:
          identity: vcap
update:
  canaries: 1
  canary_watch_time: 60000-240000
  max_in_flight: 1
  update_watch_time: 60000-240000
requires_product_versions:
- name: cf
  version: "~> 1.0"
provides_product_versions:
- name: ecs-broker
  version: '1.5.1'
post_deploy_errands:
- name: deploy-service-broker
- name: register-broker
pre_delete_errands:
- name: destroy-broker
